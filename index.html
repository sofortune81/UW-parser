// Initialize drag-and-drop and file input handling
const dropZone = document.getElementById('dropZone');
const csvFileInput = document.getElementById('csvFile');
const processButton = document.getElementById('processButton');
const errorMessage = document.getElementById('errorMessage');
const aggregateBody = document.getElementById('aggregateBody');
const mcRatioInput = document.getElementById('mcRatio');

let csvData = null;

// Handle drag-and-drop
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.csv')) {
        parseCSV(file);
    } else {
        showError('Please drop a valid CSV file.');
    }
});

// Handle file input click
dropZone.addEventListener('click', () => {
    csvFileInput.click();
});

csvFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file && file.name.endsWith('.csv')) {
        parseCSV(file);
    } else {
        showError('Please select a valid CSV file.');
    }
});

// Parse CSV file
function parseCSV(file) {
    Papa.parse(file, {
        delimiter: "|",
        header: true,
        skipEmptyLines: true,
        transformHeader: header => header.trim(), // Trim spaces from headers
        transform: value => value.replace(/^\uFEFF/, '').trim(), // Remove BOM and trim spaces from values
        complete: function(results) {
            // Validate required columns
            const requiredColumns = ['premium', 'marketcap', 'underlying_symbol'];
            const missingColumns = requiredColumns.filter(col => !results.meta.fields.includes(col));
            if (missingColumns.length > 0) {
                showError(`Missing required CSV columns: ${missingColumns.join(', ')}`);
                return;
            }

            // Validate data rows
            csvData = results.data.filter(row => {
                if (!row.premium || !row.marketcap || !row.underlying_symbol ||
                    row.premium.trim() === '' || row.marketcap.trim() === '') {
                    console.warn('Skipping invalid row:', row);
                    return false;
                }
                return true;
            });

            if (csvData.length === 0) {
                showError('No valid rows found in the CSV file.');
                return;
            }

            showError(''); // Clear any previous errors
            console.log('Parsed CSV data:', csvData);
            processButton.disabled = false; // Enable process button
        },
        error: function(error) {
            showError('Error parsing CSV: ' + error.message);
        }
    });
}

// Display error message
function showError(message) {
    errorMessage.textContent = message;
}
```javascript
// Function to send alert to Discord webhook
async function sendDiscordAlert(message) {
    const webhookUrl = 'https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN'; // Replace with your Discord webhook URL
    try {
        await fetch(webhookUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content: message,
            }),
        });
        console.log('Discord alert sent:', message);
    } catch (error) {
        console.error('Error sending Discord alert:', error);
    }
}
```
// Process and aggregate data
processButton.addEventListener('click', () => {
    if (!csvData) {
        showError('No CSV data loaded. Please upload a CSV file.');
        return;
    }

    const mcRatioThreshold = parseFloat(mcRatioInput.value);
    if (isNaN(mcRatioThreshold) || mcRatioThreshold < 0 || mcRatioThreshold > 1) {
        showError('Please enter a valid MC Ratio between 0 and 1.');
        return;
    }

    // Aggregate data by underlying_symbol
    const aggregates = {};
    csvData.forEach(row => {
        const symbol = row.underlying_symbol;
        const premium = parseFloat(row.premium.replace(/,/g, '')); // Remove commas
        const marketcap = parseFloat(row.marketcap.replace(/,/g, '')); // Remove commas

        if (!aggregates[symbol]) {
            aggregates[symbol] = {
                totalPremium: 0,
                marketcap: marketcap,
            };
        }
        aggregates[symbol].totalPremium += premium;
    });

    // Calculate ratios and filter by MC Ratio threshold
    const tableData = Object.keys(aggregates).map(symbol => {
        const { totalPremium, marketcap } = aggregates[symbol];
        const ratio = (totalPremium / marketcap).toFixed(4);
        return {
            symbol,
            totalPremium: totalPremium.toLocaleString(),
            marketcap: marketcap.toLocaleString(),
            ratio: parseFloat(ratio),
        };
    }).filter(row => row.ratio >= mcRatioThreshold);

    // Sort by ratio descending
    tableData.sort((a, b) => b.ratio - a.ratio);

    // Populate table
    aggregateBody.innerHTML = '';
    tableData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.symbol}</td>
            <td>${row.totalPremium}</td>
            <td>${row.marketcap}</td>
            <td>${row.ratio}</td>
        `;
        aggregateBody.appendChild(tr);

        // Trigger alert if ratio exceeds threshold
        if (row.ratio >= mcRatioThreshold) {
            alert(`Alert: ${row.symbol} has a Premium/Market Cap Ratio of ${row.ratio}`);
        }
    });

    if (tableData.length === 0) {
        showError('No data meets the MC Ratio threshold.');
    }
});